<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Pedidos üçß</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      padding: 20px;
    }
    h1 {
      color: #6b1e8c;
    }
    button {
      background-color: #6b1e8c;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .pedido {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
    .pendente {
      border-left: 5px solid orange;
    }
    .pedido h2 {
      margin-top: 0;
    }
    .label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Painel de Pedidos üçß</h1>
  <button onclick="carregarPedidos()">üîÑ Atualizar Pedidos</button>
  <div id="painel"></div>

  <script>
    async function carregarPedidos() {
      try {
        const response = await fetch('/pedidos');
        const pedidos = await response.json();

        // Ordena por hor√°rio (mais recente primeiro)
        pedidos.sort((a, b) => new Date(b.horario) - new Date(a.horario));

        const painel = document.getElementById('painel');
        painel.innerHTML = '';

        pedidos.forEach(p => {
          const div = document.createElement('div');
          div.className = 'pedido pendente';

          let itensHTML = p.itens.map((item, i) => `
            <p><span class="label">A√ßa√≠ ${i + 1}:</span> ${item.tamanho}</p>
            <p><span class="label">Complementos:</span> ${
              item.complementos && item.complementos.length > 0
                ? item.complementos.map(c => `üç´ ${c}`).join(', ')
                : 'Nenhum'
            }</p>
          `).join('<hr>');

          div.innerHTML = `
            <h2>Pedido #${p.id}</h2>
            <p><span class="label">Cliente:</span> ${p.cliente || 'N√£o informado'}</p>
            ${itensHTML}
            <p><span class="label">Pagamento:</span> ${p.pagamento}</p>
            <p><span class="label">Troco:</span> ${p.troco}</p>
            <p><span class="label">Endere√ßo:</span> ${p.endereco}</p>
            <p><span class="label">Hor√°rio:</span> ${new Date(p.horario).toLocaleString()}</p>
            <p><span class="label">Total:</span> R$${p.total},00</p>
            <button onclick="imprimirCupom(${p.id})">üñ®Ô∏è Imprimir Cupom</button>
            <button onclick="finalizarPedido(${p.id})">‚úÖ Finalizar</button>
          `;

          painel.appendChild(div);
        });
      } catch (error) {
        document.getElementById('painel').innerHTML = '<p>Erro ao carregar pedidos.</p>';
        console.error('Erro:', error);
      }
    }

    function imprimirCupom(id) {
      fetch('/pedidos')
        .then(res => res.json())
        .then(pedidos => {
          const pedido = pedidos.find(p => p.id === id);
          if (!pedido) return;

          const win = window.open('', '', 'width=400,height=600');
          win.document.write('<pre>');
          win.document.write('      üçß CUPOM DE PEDIDO üçß\n');
          win.document.write('-----------------------------------\n');
          win.document.write(`Pedido #${pedido.id}\n`);
          win.document.write(`Cliente: ${pedido.cliente}\n`);
          pedido.itens.forEach((item, i) => {
            win.document.write(`\nA√ßa√≠ ${i + 1} - ${item.tamanho}\n`);
            win.document.write(`Complementos:\n`);
            if (item.complementos.length > 0) {
              item.complementos.forEach(c => win.document.write(` - ${c}\n`));
            } else {
              win.document.write(` - Nenhum\n`);
            }
          });
          win.document.write('\n-----------------------------------\n');
          win.document.write(`Pagamento: ${pedido.pagamento}\n`);
          win.document.write(`Troco: ${pedido.troco}\n`);
          win.document.write(`Endere√ßo: ${pedido.endereco}\n`);
          win.document.write(`Total: R$${pedido.total},00\n`);
          win.document.write(`Hor√°rio: ${new Date(pedido.horario).toLocaleString()}\n`);
          win.document.write('-----------------------------------\n');
          win.document.write('Obrigado pela prefer√™ncia! üçß\n');
          win.document.write('</pre>');
          win.print();
        });
    }

    function finalizarPedido(id) {
      fetch('/finalizar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        carregarPedidos();
      })
      .catch(err => console.error('Erro:', err));
    }

    // Carregar pedidos automaticamente ao abrir
    carregarPedidos();
  </script>
</body>
</html>
